---
title: pytestã‹ã‚‰ãƒ†ã‚¹ãƒˆä»•æ§˜æ›¸ã½ã„ã‚‚ã®ã‚’ç”Ÿæˆã™ã‚‹
published: 2021-09-18
tags:
  - Python
---

[pytest](https://docs.pytest.org/en/6.2.x/index.html)ãªã‚“ã‹ã‚’ä½¿ã£ã¦ãƒ†ã‚¹ãƒˆã‚’æ›¸ãã¨ã‚³ãƒãƒ³ãƒ‰ 1 ç™ºã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ãã‚Œã¦å¬‰ã—ã„ã§ã™ã€‚ã§ã‚‚ã€å®Ÿè¡Œã—ãŸãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã¨çµæœã‚’ã¾ã¨ã‚ãŸè³‡æ–™ï¼ˆã“ã“ã§ã¯ãƒ†ã‚¹ãƒˆä»•æ§˜æ›¸ã¨å‘¼ã¶ã“ã¨ã«ã—ã¾ã™ï¼‰ã‚’æ±‚ã‚ã‚‰ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

ãƒ†ã‚¹ãƒˆã¯ã‚³ãƒãƒ³ãƒ‰ 1 ç™ºãªã®ã«ã€ãƒ†ã‚¹ãƒˆä»•æ§˜æ›¸ã®ä½œæˆãŒæ‰‹ä½œæ¥­ã¯ã¤ã‚‰ã„ã§ã™ã‚ˆã­ã€‚

## pytest-html

[pytest-html](https://github.com/pytest-dev/pytest-html)ã¯ pytest ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã§ã€pytest ã§å®Ÿè¡Œã—ãŸãƒ†ã‚¹ãƒˆçµæœã‚’ html ã®ãã‚Œã„ãªãƒ¬ãƒãƒ¼ãƒˆã¨ã—ã¦å‡ºåŠ›ã—ã¦ãã‚Œã¦ã¨ã¦ã‚‚ä¾¿åˆ©ã§ã™ã€‚ãŸã ã€pytest-html ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å‡ºåŠ›ã§ã¯ãƒ†ã‚¹ãƒˆä»•æ§˜æ›¸ã¨å‘¼ã¶ã«ã¯å¿ƒã‚‚ã¨ãªã„æ°—ãŒã—ã¾ã™ã€‚å°‘ãªãã¨ã‚‚ã€ã–ã£ãã‚Šã€Œãƒ†ã‚¹ãƒˆå†…å®¹ã€ã¨ã€ŒæœŸå¾…çµæœã€ã® 2 ã¤ãã‚‰ã„ã¯å‡ºåŠ›ã—ãŸã„ã‚‚ã®ã§ã™ã€‚

ãã“ã§ã€å„ãƒ†ã‚¹ãƒˆã«å¯¾ã—ã¦ã€Œãƒ†ã‚¹ãƒˆå†…å®¹ã€ã¨ã€ŒæœŸå¾…çµæœã€ã‚’ Docstring ã«è¨˜è¼‰ã—ã¦ã€pytest-html ã®ãƒ¬ãƒãƒ¼ãƒˆã«å‡ºåŠ›ã™ã‚‹ã“ã¨ã«ã—ã¾ã™ã€‚

## Docstring ã®å†…å®¹ã‚’å–ã‚Šè¾¼ã‚€

ãŸã¨ãˆã°ã€ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ†ã‚¹ãƒˆã‚’è€ƒãˆã¾ã™ã€‚

```py
def test_aho():
    """
    Tests:
        3ã‚’å…¥åŠ›ã™ã‚‹ã€‚
    Expects:
        ã‚ã»ã«ãªã‚‹ã“ã¨ã€‚
    """
    assert is_aho(3)
```

Tests ã¨ã„ã†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒã€Œãƒ†ã‚¹ãƒˆå†…å®¹ã€ã§ã€Expects ã¨ã„ã†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒã€ŒæœŸå¾…çµæœã€ã®ã“ã¨ã§ã™ã€‚ã“ã“ã§ã¯ Google ã‚¹ã‚¿ã‚¤ãƒ«ã£ã½ãè¨˜è¿°ã—ã¦ã„ã¾ã™ã€‚

### Docstring ã‚’ãƒ‘ãƒ¼ã‚¹â€¦

ãŸã¨ãˆã°ä»¥ä¸‹ã®ã‚ˆã†ãªã¦ãã¨ãƒ¼ãªãƒ‘ãƒ¼ã‚µã‚’æ›¸ãã¾ã™ã€‚ï¼ˆğŸš§ **ã¦ãã¨ãƒ¼**ãªã®ã§é©å®œæ›¸ãç›´ã™ãªã‚Šã—ã¦ãã ã•ã„â€¦ğŸš§ï¼‰

```py

import re
from itertools import takewhile


_section_rgx = re.compile(r"^\s*[a-zA-Z]+:\s*$")
_lspace_rgx = re.compile(r"^\s*")


def _parse_section(lines: list[str]) -> list[tuple[int, str]]:
    matches = map(lambda x: _section_rgx.match(x), lines)
    indexes = [i for i, x in enumerate(matches) if x is not None]
    return list(map(lambda x: (x, lines[x].strip()[:-1]), indexes))


def _count_lspace(s: str) -> int:
    rgx = _lspace_rgx.match(s)
    if rgx is not None:
        return rgx.end()
    return 0


def _parse_content(index: int, lines: list[str]) -> str:
    lspace = _count_lspace(lines[index])
    i = index + 1
    contents = takewhile(lambda x: _count_lspace(x) > lspace, lines[i:])
    return "".join(map(lambda x: x.strip(), contents))


def parse(docstring: str) -> dict[str, str]:
    """ğŸš§sloppy docstring parserğŸš§"""
    lines = docstring.splitlines()
    sections = _parse_section(lines)
    return dict(map(lambda x: (x[1], _parse_content(x[0], lines)), sections))
```

ã“ã‚Œã§ï¼ˆå°‘ãªãã¨ã‚‚ä¸Šè¨˜ã®ãƒ†ã‚¹ãƒˆã¯ï¼‰å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³åã¨ãã®å†…å®¹ãŒ Dictionary ã§è¿”ã£ã¦ãã¾ã™ã€‚

### conftest.py

conftest.py[^conftest.py] ã§ãŸã¨ãˆã°ä»¥ä¸‹ã®ã‚ˆã†ã«è¨˜è¼‰ã—ã¦ pytest-html ã®ãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ã¾ã™ã€‚

```py
from datetime import datetime
from py.xml import html  # type: ignore
import pytest

import docstring_parser


def pytest_html_report_title(report):
    report.title = "ãƒŠãƒ™ã‚¢ãƒ„ ãƒ†ã‚¹ãƒˆä»•æ§˜æ›¸" # ã¤ã„ã§ã«ãƒ¬ãƒãƒ¼ãƒˆã‚¿ã‚¤ãƒˆãƒ«ã‚’å¤‰æ›´


def pytest_configure(config):
    config._metadata["Version"] = "9.9.9" # ã¤ã„ã§ã«Versionæƒ…å ±ã‚’è¿½åŠ 


def pytest_html_results_table_header(cells):
    del cells[1:]
    cells.insert(0, html.th("Tests"))
    cells.insert(1, html.th("Expects"))
    cells.append(html.th("Time", class_="sortable time", col="time"))


def pytest_html_results_table_row(report, cells):
    del cells[1:]
    cells.insert(0, html.td(report.tests)) #ã€Œãƒ†ã‚¹ãƒˆå†…å®¹ã€ã‚’ãƒ¬ãƒãƒ¼ãƒˆã«å‡ºåŠ›
    cells.insert(1, html.td(report.expects)) #ã€ŒæœŸå¾…çµæœã€ã‚’ãƒ¬ãƒãƒ¼ãƒˆã«å‡ºåŠ›
    cells.append(html.td(datetime.now(), class_="col-time")) #ã¤ã„ã§ã«ã€Œæ™‚é–“ã€ã‚‚ãƒ¬ãƒãƒ¼ãƒˆã«å‡ºåŠ›


@pytest.hookimpl(hookwrapper=True)
def pytest_runtest_makereport(item, call):
    outcome = yield
    report = outcome.get_result()
    docstring = docstring_parser.parse(str(item.function.__doc__))
    report.tests = docstring["Tests"] #ã€Œãƒ†ã‚¹ãƒˆå†…å®¹ã€ã‚’`report`ã«è¿½åŠ 
    report.expects = docstring["Expects"] #ã€ŒæœŸå¾…çµæœã€ã‚’`report`ã«è¿½åŠ 
```

ã¡ãªã¿ã«ã§ã™ãŒã€ã»ã¨ã‚“ã©[å…¬å¼ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¬ã‚¤ãƒ‰](https://pytest-html.readthedocs.io/en/latest/user_guide.html#modifying-the-results-table)ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ã§ã™ã€‚

## ç”Ÿæˆã•ã‚Œã‚‹ãƒ¬ãƒãƒ¼ãƒˆ

ã‚ã¨ã¯ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã™ã‚‹ã ã‘ã§ã™ã€‚

```bash
pytest --html=report.html
```

ã™ã‚‹ã¨ report.html ã¨ã—ã¦ä»¥ä¸‹ã®ãƒ¬ãƒãƒ¼ãƒˆãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚

![ç”Ÿæˆã•ã‚ŒãŸãƒ¬ãƒãƒ¼ãƒˆ](./report.PNG)

ã€Œãƒ†ã‚¹ãƒˆå†…å®¹ã€ã¨ã€ŒæœŸå¾…çµæœã€ãŒã‚ã‚Šãã‚Œã«å¯¾ã™ã‚‹ã€Œãƒ†ã‚¹ãƒˆçµæœã€ãŒã¾ã¨ã¾ã£ã¦ã„ã¦[^ã‚¨ã‚¯ã‚»ãƒ«]ã€æœ€ä½é™ã¯ãƒ†ã‚¹ãƒˆä»•æ§˜æ›¸ã£ã½ããªã‚Šã¾ã—ãŸã€‚ã‚„ã£ãŸã­ã€‚

## ãŠã‚ã‚Šã«

ä»Šå›ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ãŸã„ã¨ã„ã†ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‚‰å„ãƒ†ã‚¹ãƒˆã«ã€Œãƒ†ã‚¹ãƒˆå†…å®¹ã€ã¨ã€ŒæœŸå¾…çµæœã€ã‚’ Docstring ã«è¨˜è¼‰ã—ã¾ã—ãŸãŒã€çµæœã¨ã—ã¦ãƒ†ã‚¹ãƒˆã‚‚èª­ã¿ã‚„ã™ããªã£ã¦è‰¯ã„ã‹ã‚“ã˜ãªæ°—ãŒã—ã¾ã™ã€‚

ä»Šå›ä½¿ç”¨ã—ãŸã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯ä¸€å¿œ[GitHub](https://github.com/tamaosa/pytest-html-sample)ã«ã‚‚ã‚ã’ã¦ã„ã‚‹ã®ã§ã‚ˆã‘ã‚Œã°å‚è€ƒã«ã—ã¦ã¿ã¦ãã ã•ã„ã€‚

## å‚è€ƒ

- [User Guide - pytest-html](https://pytest-html.readthedocs.io/en/latest/user_guide.html)
- [ãƒ†ã‚¹ãƒˆä»•æ§˜æ›¸](https://qiita.com/jun2014/items/cad7328978e709fe79f4)

[^conftest.py]: å…±é€šã®ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ã‚’å®šç¾©ã—ãŸã‚Šã§ä½¿ã†ã‚ã‚Œã§ã™ã­ã€‚
[^ã‚¨ã‚¯ã‚»ãƒ«]: è¡¨å½¢å¼ãªã®ã§æœ€æ‚ªã®å ´åˆã‚³ãƒ”ãƒšã§ã‚¨ã‚¯ã‚»ãƒ«ã«æŒã£ã¦ã„ã‘ã‚‹ã®ãŒåœ°å‘³ã«å¬‰ã—ã‹ã£ãŸã‚Šã‚‚ã—ã¾ã™â€¦
